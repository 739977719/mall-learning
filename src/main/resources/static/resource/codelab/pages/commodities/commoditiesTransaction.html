<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>商品交易</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" href="../../lib/layui-v2.6.8/layui/css/layui.css" media="all">
  <link rel="stylesheet" href="../../lib/font-awesome-4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="../../css/public.css" media="all">
  <style>
    .container {
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
    }

    .title {
      text-align: center;
      margin-bottom: 20px;
    }

    .form-box {
      margin-top: 20px;
    }

    .result-box {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ccc;
      background-color: #f5f5f5;
    }

    /* 调整输入框宽度 */
    .layui-input-inline {
      display: inline-block;
      width: 200px;
      /* 自行调整宽度 */
    }

    /* 将最低价格和最高价格放在同一行 */
    .price-input-container {
      display: flex;
    }
    /*居中表单*/
    .query-box {
      display: flex;
      justify-content: center;
    }

    .quantity-input {
      width: 60px;
    }
    

  </style>
</head>

<body>
  <div class="container">
    <h2 class="title">商品交易</h2>
    <h4 class="title" style="color:red">* 购买前先查询商品当前状态，请输入商品信息</h4>

    <div class="form-box" >
      <form class="layui-form" lay-filter="searchForm" >
        <div class="layui-form-item">
          <label class="layui-form-label">商品名称</label>
          <div class="layui-input-block">
            <input type="text" name="commoditiesName" placeholder="请输入商品名称" autocomplete="off"
              class="layui-input">
          </div>
        </div>
        <div class="layui-form-item">
          <label class="layui-form-label">商品类别</label>
          <div class="layui-input-block">
            <input type="text" name="category" placeholder="请输入商品类别" autocomplete="off" class="layui-input">
          </div>
        </div>
        <div class="layui-form-item">
          <label class="layui-form-label">价格范围</label>
          <div class="price-input-container">
            <div class="layui-input-inline">
              <input type="text" name="minPrice" placeholder="最低价格" autocomplete="off" class="layui-input">
            </div>
            <div class="layui-form-mid">-</div>
            <div class="layui-input-inline">
              <input type="text" name="maxPrice" placeholder="最高价格" autocomplete="off" class="layui-input">
            </div>
          </div>
        </div>
        <div class="layui-form-item">
          <div class="layui-input-block">
            <button class="layui-btn" lay-submit lay-filter="search">查询</button>
          </div>
        </div>
      </form>
    </div>
    <div class="query-box">
      <div id="result-box"  class="result-box layui-hide">
        <h3>查询结果：</h3>
        <div id="resultBox" style="margin-top: 20px;"></div>
    </div>
    </div>
  </div>
  <script src="../../lib/jquery-3.4.1/jquery-3.4.1.min.js" charset="utf-8"></script>
  <script src="../../lib/layui-v2.6.8/layui/layui.js" charset="utf-8"></script>
  <script src="../../frame/js/lay-config.js" charset="utf-8"></script>
  <script src="../../js/lay-config-cl.js" charset="utf-8"></script>
  <script>
    layui.use(['form', 'ClUtils', 'DZUtils'], function () {
      var form = layui.form;
      var ClUtils = layui.ClUtils;
      var DZUtils = layui.DZUtils;

      // 监听查询表单提交
      form.on('submit(search)', function (data) {
        //显示查询框
        $('#result-box').removeClass('layui-hide');
        // 发送查询请求
        queryProductStatus(data.field);
        return false; // 阻止表单默认提交行为
      });

      // 查询商品状态
      function queryProductStatus(formData) {
        // 构造请求URL，将商品信息以json格式发送到服务端
        var submitUrl = ClUtils.rootPath + '/dz-ftsp/codelab/transaction/searchCommodities'
        // 发送Post请求
        // 使用Layui的`layer.load()`方法显示加载动画
        layer.load();
        DZUtils.ajaxPost2(submitUrl, formData, function (res) {
          // 处理查询结果
          displayProductStatus(res.result);
          // 关闭加载动画
          layer.closeAll('loading');
        });
      }

      // 显示查询结果
      function displayProductStatus(products) {
        var resultBox = $('#resultBox');
        // 清空之前的查询结果
        resultBox.empty();
      
        // 创建商品信息表格
        var table = $('<table class="layui-table"></table>');
        var thead = $('<thead></thead>');
        var tbody = $('<tbody></tbody>');
      
        // 创建表头
        var headRow = $('<tr></tr>');
        headRow.append('<th>商品名称</th>');
        headRow.append('<th>价格</th>');
        headRow.append('<th>库存</th>');
        headRow.append('<th>数量</th>');
        <!-- headRow.append('<th>月售量</th>'); -->
        thead.append(headRow);
      
        // 创建表格内容
        for (var i = 0; i < products.length; i++) {
          var product = products[i];
          var row = $('<tr></tr>');
          row.append('<td>' + product.commoditiesName + '</td>');
          row.append('<td>' + product.price + '</td>');
          row.append('<td>' + product.inventory + '</td>');
          var quantityInput = $('<input type="number" class="quantity-input" value="0" min="0">');
          var purchaseQuantityCell = $('<td></td>');
          purchaseQuantityCell.append(quantityInput);
          var purchaseBtn = $('<button class="layui-btn layui-btn-sm purchase-button">购买</button>');
          purchaseBtn.data('productId', product.id);
          purchaseBtn.data('commoditiesName', product.commoditiesName);
          purchaseBtn.data('price', product.price);
          var purchaseCell = $('<td></td>');
          purchaseCell.append(purchaseBtn);
          row.append(purchaseQuantityCell);
          row.append(purchaseCell);
          tbody.append(row);
          //console.log(product.inventory);
        }
      
        // 将表头和表格内容添加到表格中
        table.append(thead);
        table.append(tbody);
      
        // 将表格添加到结果框中
        resultBox.append(table);


        $('.purchase-button').on('click', function() {
          var productId = $(this).data('productId');
          var commoditiesName = $(this).data('commoditiesName');
          var price = $(this).data('price');
          var quantityStr = $(this).closest('tr').find('.quantity-input').val(); // 获取数量输入框的值
          var quantity = parseInt(quantityStr, 10); // 将字符串转换为整数，第二个参数指定进制，默认为 10 进制
          var submitData = { id: productId, commoditiesName:commoditiesName, price:price, quantity:quantity};
          console.log(submitData);
          // 在这里处理购买按钮点击事件的逻辑
          // 可以使用 productId 获取对应商品的信息，并执行购买操作
          var submitUrl = ClUtils.rootPath + '/dz-ftsp/codelab/transaction/purchaseCommodities';
          // 发送 Post 请求
          // 使用 Layui 的 `layer.load()` 方法显示加载动画
          layer.load();
          DZUtils.ajaxPost2(submitUrl, submitData , function (res) {
            // 处理返回结果
            if(res.errorNo === 0){
              layer.msg('购买成功')
              layer.close(layer.load());
            }else{
              layer.msg('库存不足');
              layer.close(layer.load());
            }

          });
        });

      }
    });
  </script>
</body>

</html>